name: CD-Dev

on:
  pull_request:
    branches:
      - "main"
  push:
    branches: ["main"]

concurrency:
  group: creditto
  cancel-in-progress: true

jobs:
  CI:
    runs-on: self-hosted

    steps:
      - name: Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v3

      - name: JDK17 ÏÑ§Ïπò
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: "17"

      - name: .env ÌååÏùº ÏÉùÏÑ±
        run: |

          # .env ÌååÏùº ÏÉùÏÑ±
          touch .env

          # .env ÌååÏùº ÏûëÏÑ±
          echo "${{ secrets.ENV_DEV_FILE }}" >> .env

          chmod 600 .env

        shell: bash

      - name: build & sonarqube Ïã§Ìñâ
        run: |
          chmod +x gradlew
          ./gradlew clean build sonar \
            -Dspring.profiles.active=dev \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_NAME }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

        shell: bash

      - name: SonarQube Quality Gate check
        id: sonarqube-quality-gate-check
        uses: sonarsource/sonarqube-quality-gate-action@master
        with:
          pollingTimeoutSec: 600
          scanMetadataReportFile: build/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: clean
        run: |
          rm .env
        shell: bash

      - name: Docker Hub Î°úÍ∑∏Ïù∏
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Docker Image ÎπåÎìú Î∞è ÌÉúÍπÖ
        run: |
          VERSION=0.${{ github.run_number }}
          echo "VERSION=$VERSION"
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$VERSION .
          docker tag  ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$VERSION \
                      ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:lts

      - name: Docker Image Ìë∏Ïâ¨
        run: |
          VERSION=0.${{ github.run_number }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$VERSION
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:lts

  CD:
    needs: CI
    runs-on: self-hosted

    steps:
      - name: .env ÌååÏùº Ï†ÑÎã¨
        run: |
          echo "${{ secrets.ENV_DEV_FILE }}" > .env

      - name: .env ÌååÏùº ÏóÖÎ°úÎìú
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: ".env"
          target: ${{ secrets.EC2_ENV_PWD }}
          overwrite: true

      - name: DOCKER Ïª®ÌÖåÏù¥ÎÑà Ïã§Ìñâ
        uses: appleboy/ssh-action@master
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PW:   ${{ secrets.DOCKERHUB_PASSWORD }}
          IMAGE_NAME:  ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}
          IMAGE_TAG:   lts
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: DOCKER_USER,DOCKER_PW,IMAGE_NAME,IMAGE_TAG
          script: |
            export DOCKER_USER="${DOCKER_USER}"
            export DOCKER_PW="${DOCKER_PW}"
            export IMAGE_NAME="${IMAGE_NAME}"
            export IMAGE_TAG="${IMAGE_TAG}"
            bash ${{ secrets.DEPLOY_SCRIPT_PATH }}

      - name: Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "Health Check ÏãúÏûë...ü©∫"

            for i in {1..10}
            do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.HEALTH_URL }})
              if [ "$STATUS" -eq 200 ]; then
                echo "‚úÖ ÏÑúÎ≤Ñ Ï†ïÏÉÅ ÏùëÎãµ (HTTP 200)"
                exit 0
              fi

              echo "‚è≥ ÏÑúÎ≤Ñ Í∏∞Îèô ÎåÄÍ∏∞Ï§ë... ($i/10)"
              sleep 5
            done

            echo "‚ùå Health Check Ïã§Ìå®"
            exit 1

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf build
          docker system prune -af --volumes
        shell: bash